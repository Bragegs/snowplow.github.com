---
layout: post
title: Avalanche 0.1.0 released
title-short: Avalanche 0.1.0
tags: [snowplow, analytics, gatling, load-testing]
author: Josh
category: Releases
---

We are pleased to announce the release of [Avalanche] [avalanche-repo] the Snowplow load-testing project. This project aims to bring very powerful load-testing abilities to Snowplow so we can ensure that under any amount of pressure our Pipelines will work as expected.  It will also hopefully expand ours and the communities knowledge on what configurations work best and to discover (and then remove!) limitations that we might come across.

In the rest of this post we will cover:

1. [How to setup the environment](/blog/2016/05/18/avalanche-0.1.0-released/#how-to-setup)
2. [How to access results](/blog/2016/05/18/avalanche-0.1.0-released/#how-to-access-results)
3. [Clojure Collectors and what we have learned](/blog/2016/05/18/avalanche-0.1.0-released/#learning)
4. [Roadmap](/blog/2016/05/18/avalanche-0.1.0-released/#roadmap)
5. [Documentation](/blog/2016/05/18/avalanche-0.1.0-released/#docs)
6. [Getting help](/blog/2016/05/18/avalanche-0.1.0-released/#help)

<!--more-->

<h2 id="how-to-setup">1. How to setup the environment</h2>

Avalanche comes pre-packaged as an AMI available directly from the Community AMIs section when launching a fresh instance.  Simply search for `snowplow-avalanche-0.1.0` to find the required AMI and then follow [these setup instructions](https://github.com/snowplow/avalanche#to-run-a-simulation-from-an-ec2-instance) to get started.

Under the hood Avalanche uses the excellent [Gatling.io][gatling-lib] load-testing framework to send huge amounts of requests to our Collectors.

Once the instance has been launched and you have SSHed onto the box you will need to setup your environment variables for the simulation:

* `SP_COLLECTOR_URL` : Your Snowplow Collector endpoint.
* `SP_SIM_TIME` : The total simulation time in minutes.
* `SP_BASELINE_USERS` : The base amount of users that are pinging the collector.
* `SP_PEAK_USERS` : The peak amount of users to load test up until.

You can then go ahead and launch Gatling using either our launch script:

{% highlight bash %}
ubuntu$ ./snowplow/scripts/2_run.sh
{% endhighlight %}

Or you can launch it yourself:

{% highlight bash %}
ubuntu$ /home/ubuntu/snowplow/gatling/gatling-charts-highcharts-bundle-2.2.1-SNAPSHOT/bin/gatling.sh -sf /home/ubuntu/snowplow/src
{% endhighlight %}

After which you can select the simulation you wish to run:

{% highlight bash %}
Choose a simulation number:
     [0] com.snowplowanalytics.avalanche.ExponentialPeak
     [1] com.snowplowanalytics.avalanche.LinearPeak
{% endhighlight %}

Or to directly launch the simulation without any interaction:

{% highlight bash %}
ubuntu$ /home/ubuntu/snowplow/gatling/gatling-charts-highcharts-bundle-2.2.1-SNAPSHOT/bin/gatling.sh -sf /home/ubuntu/snowplow/src -s com.snowplowanalytics.avalanche.ExponentialPeak
{% endhighlight %}

> The above can be useful if you wish to run Avalanche across many EC2 instances at the same time and would like to supply the launch command within the User-Data section in place of having to SSH onto the instance.

For very high throughputs you will need to contact Amazon Technical Support to have them pre-warm your Load Balancer to be able to handle the throughput being generated by Gatling.

__Note__: In testing Gatling's throughput we comfortably managed 825,000 requests per minute from a single c4.8xlarge instance.  For more than this we recommend moving to running Avalanche from multiple instances.

<h2 id="how-to-access-results">2. How to access results</h2>

Gatling generates results as a simple webpage.  The directory these result pages are stored in is determined by the `-rf` flag being passed when you launch Gatling.  By default this is set to `/home/ubuntu/snowplow/results` - when launching via the `2_run.sh` script.

To easily view these simulations from the actual instance:

{% highlight bash %}
ubuntu$ cd /home/ubuntu/snowplow/results
ubuntu$ sudo python -m SimpleHTTPServer 80
{% endhighlight %}

Then navigate to the instance DNS found within your EC2 console and select the relevant result file you wish to review.

<h2 id="learning">3. Clojure Collectors and what we have learned</h2>

Avalanche has the ability to simulate both linear and exponential increases in load up to 820 thousand requests per minute (from a single instance - potentially more!).  At Snowplow we use this to assert that the scaling rules we have in place are working optimally and will continue to work under any amount of load.

We recently put the Clojure Collector, our most battle-tested deployment, through its paces with Avalanche.  The test was configured as follows:

* Instance Type: m3.medium
* Simulation time: 180 minutes
* Baseline users: 100 (~6,000 requests per minute)
* Peak users: 15000 (~900,000 requests per minute)
* Loading type: Linear
* Scaling based on CPU and Network Latency

This test resulted in an 150x load increase in just under 60 minutes.  At this point the load was held for ~35 minutes before being scaled back down over the next 60 minutes.

![Requests Over Time][img1]
![Average Latency][img2]
![CPU Average][img3]

The images above illustrate that the initial load increase gave a very high latency increase (Image 2) and that a lot of the requests were failing as seen by the less than linear line of HTTP requests initially (Image 1).  However the scaling rules aggressivly began provisioning instances to deal with the influx.  Within 15 minutes the latency had been reduced back to ~5-10 milliseconds, the linear line had been restored and the scaling had stabilized at 17 collectors.  This number was scaled up to 55 collectors at its peak to deal with the 825,000 odd requests per minute.

This result was only attained after much trial and error with our scaling rules.  Previously we had limited our scaling logic to using solely CPU and then scaling quite passively, 1 instance at a time.  From testing with Avalanche we have updated this logic to be much more aggressive and, as you can see, able to withstand huge growth comfortably so as to recover with a minimum of fuss.

The changes involved:

* Step-Scaling rules so we can better handle the situation at hand: If the collectors are hovering at roughly 60% CPU usage a single extra instance will bring it back to within a healthy zone.  If howver they are at 90%+ an extra instance is still going to help - but it is not going to bring the cluster into a healthy state.  In this case we now bring 3 instances in to quickly resolve the extra load being seen.

* Latency based scaling: At heart the Collector is a web-server and the most important metric for a web-server is how long it takes to get a response from it.  If the Collector has low latency it is probably doing okay - if it has very high latency (regardless of its CPU usage) something is struggling and we probably need another instance.  As above depending on how high the latency has gone we will provision a different number of extra instances to recover as quickly as possible.

<h2 id="roadmap">4. Roadmap</h2>

We have big plans for Avalanche at Snowplow, including:

* Building an interactive front-end UI with full auditing capabilities ([#6][6])
* Adding ability to run Avalanche on Blazemeter ([#2][2])

Of course we also plan to add many more simulations!

<h2 id="docs">5. Documentation</h2>

* [Avalanche usage manual] [avalanche-manual] for setting up and running your own load tests

<h2 id="help">6. Getting help</h2>

We hope that you find Avalanche useful - of course, this is only its first release, so don't be afraid to [get in touch][talk-to-us] or [raise an issue] [avalanche-issues] on GitHub!

[gatling-lib]: http://gatling.io/docs/2.1.7/
[img1]: /assets/img/blog/2016/05/avalanche-requests.png
[img2]: /assets/img/blog/2016/05/avalanche-latency-1.png
[img3]: /assets/img/blog/2016/05/avalanche-cpu.png
[2]: https://github.com/snowplow/avalanche/issues/2
[6]: https://github.com/snowplow/avalanche/issues/6
[avalanche-repo]: https://github.com/snowplow/avalanche
[avalanche-issues]: https://github.com/snowplow/avalanche/issues
[avalanche-manual]: https://github.com/snowplow/avalanche/blob/master/README.md
[talk-to-us]: https://github.com/snowplow/snowplow/wiki/Talk-to-us
